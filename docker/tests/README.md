# Тесты приложения TODO-PHP

## Обзор

Директория `docker/tests/` содержит автоматизированные тесты для проверки функциональности приложения TODO-PHP.

## Структура тестов

```
docker/tests/
├── README.md              # Этот файл
├── run-tests.sh          # Главный скрипт запуска всех тестов
├── test-task-list.sh     # Тест получения списка задач
└── test-task-create.sh   # Тест создания задач с автоматической очисткой
```

## Запуск тестов

### Через Makefile (рекомендуемый способ)
```bash
make test
```

### Ручной запуск
```bash
# Из корневой директории проекта
./docker/tests/run-tests.sh

# Или напрямую через docker-compose
docker-compose exec fpm /var/www/todo-php/docker/tests/test-task-list.sh
docker-compose exec fpm /var/www/todo-php/docker/tests/test-task-create.sh

## Описание тестов

### 1. Тест списка задач (`test-task-list.sh`)

**Цель:** Проверка получения списка задач через API

**Что тестируется:**
- Корректность JSON ответа
- Структура данных (current, rowCount, rows, total)
- Наличие обязательных полей
- Правильность пагинации
- **Новая возможность:** Обработка пустых списков задач без ошибок

**Ожидаемый результат:**
```json
{
  "current": 1,
  "rowCount": 3,
  "rows": [...],
  "total": 10
}
```

### 2. Тест создания задач (`test-task-create.sh`)

**Цель:** Проверка создания новых задач через API

**Что тестируется:**
- Создание задачи с тестовыми данными
- Корректность валидации данных
- Возврат ID созданной задачи
- Статус успешного создания
- **Новая возможность:** Автоматическая очистка созданных тестовых задач

**Ожидаемый результат:**
```json
{
  "id": 123,
  "status": "Created"
}
```

## Новые возможности тестирования

### Автоматическая обработка пустых списков
- **test-task-list.sh** теперь корректно обрабатывает случаи, когда список задач пустой
- Проверяет наличие обязательных полей JSON вместо конкретных значений
- Предотвращает ложные срабатывания при отсутствии данных

### Улучшенная обработка ошибок
- **run-tests.sh** включает автоматическую очистку при неудачных тестах
- Более подробные сообщения об ошибках
- Лучшая диагностика проблем

## Предварительные требования

1. **Запущенные контейнеры:**
   ```bash
   make up
   ```

2. **Работоспособное приложение:**
   - Доступность по адресу `http://127.0.0.1:8081/`
   - Функционирующая база данных
   - Установленные зависимости Composer

## Добавление новых тестов

### Доступные endpoints для тестирования

- `task/post` - создание новой задачи
- `task/list` - получение списка задач

### Шаблон для нового теста:
```bash
#!/bin/bash

# Скрипт тестирования [функциональность]
# Выполняется в контейнере fpm

echo "=== Тестирование [функциональность] ==="
echo ""

# Параметры тестирования
BASE_URL="http://nginx:80"
CONTROLLER="[controller]"
ACTION="[action]"

# Выполнение curl запроса
RESPONSE=$(curl -s "$BASE_URL/index.php?controller=$CONTROLLER&action=$ACTION" \
  [параметры curl])

echo "Ответ сервера:"
echo "$RESPONSE"
echo ""

# Проверка ответа
if [[ $RESPONSE == *"[ожидаемый текст]"* ]]; then
    echo "✅ Тест пройден успешно!"
else
    echo "❌ Тест провален!"
    exit 1
fi

echo ""
echo "=== Тестирование завершено ==="
```

### Добавление теста в общий запуск:
1. Создать новый скрипт `test-[feature].sh`
2. Сделать его исполняемым: `chmod +x test-[feature].sh`
3. Добавить запуск в `run-tests.sh`

## Отладка тестов

### Просмотр детального вывода:
```bash
# Запуск с подробным выводом
docker-compose exec fpm bash -c "cd /var/www/todo-php && ./docker/tests/test-task-list.sh"

# Или с сохранением логов
docker-compose exec fpm bash -c "cd /var/www/todo-php && ./docker/tests/test-task-list.sh" 2>&1 | tee test.log
```

### Проверка сетевых подключений:
```bash
# Проверка доступности nginx из контейнера fpm
docker-compose exec fpm curl -I http://nginx:80/

# Проверка базы данных
docker-compose exec fpm php -r "new PDO('mysql:host=mysql;dbname=todo-php', 'root', 'root'); echo 'DB OK';"
```

## CI/CD интеграция

Тесты можно интегрировать в процесс непрерывной интеграции:

```yaml
# Пример для GitHub Actions
- name: Run API Tests
  run: |
    make up
    sleep 10
    make test

## Мониторинг и отчетность

### Сбор метрик:
- Время выполнения тестов
- Процент успешных тестов
- Время отклика API
- Нагрузка на ресурсы

### Отчеты:
- Автоматическая генерация отчетов
- Сохранение результатов в файлы
- Визуализация результатов

---

*Дата последнего обновления: 2025-08-27*
*Версия приложения: PHP 8.1 + Argon2ID*
*Новые возможности: Автоматическая очистка тестовых данных, улучшенная обработка пустых списков*