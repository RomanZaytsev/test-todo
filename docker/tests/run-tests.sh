#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ —Ö–æ—Å—Ç–∞
# –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–µ—Å—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ fpm

echo "=== –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
if ! docker-compose ps | grep -q "todo-php_fpm.*Up"; then
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä fpm –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π: make up"
    exit 1
fi

if ! docker-compose ps | grep -q "todo-php_nginx.*Up"; then
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π: make up"
    exit 1
fi

echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã"
echo ""

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á..."
docker-compose exec -T fpm /var/www/todo-php/docker/tests/test-task-list.sh

TEST1_RESULT=$?

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á
echo ""
echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á..."
docker-compose exec -T fpm /var/www/todo-php/docker/tests/test-task-create.sh

TEST2_RESULT=$?

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
if [ $TEST1_RESULT -eq 0 ] && [ $TEST2_RESULT -eq 0 ]; then
    echo ""
    echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    echo "   ‚úÖ –¢–µ—Å—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á: –ü–†–û–ô–î–ï–ù"
    echo "   ‚úÖ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á: –ü–†–û–ô–î–ï–ù"
else
    echo ""
    echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã!"

    if [ $TEST1_RESULT -ne 0 ]; then
        echo "   ‚ùå –¢–µ—Å—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á: –ü–†–û–í–ê–õ–ï–ù"
    else
        echo "   ‚úÖ –¢–µ—Å—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á: –ü–†–û–ô–î–ï–ù"
    fi
    if [ $TEST2_RESULT -ne 0 ]; then
        echo "   ‚ùå –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á: –ü–†–û–í–ê–õ–ï–ù"
    else
        echo "   ‚úÖ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á: –ü–†–û–ô–î–ï–ù"
    fi
    exit 1
fi